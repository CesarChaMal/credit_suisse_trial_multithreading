/**
 *
 * @module YoutubeDataContext
 * @file youtube-data.js
 * @author David Reilly <dreilly@authxconsulting.com>
 * @version 1.1; revised on 2014-10-27 (DBR)
 */
define(["thirdparty/vendor/jquery","console"],function($,console){"use strict";var YouTube={jQueryVersion:null,YouTubeDataContext:function(){}};return YouTube.isJqueryElement=function(element){if("object"!=typeof element)return!1;var constructorString=Object.getPrototypeOf(element).constructor.toString(),plainDomElementRegExp=/\s*(?:function)\s([^\s\(]+)\([^\)]*\).*/,plainDomElementResult=constructorString.match(plainDomElementRegExp);if(null===plainDomElementResult){if("jquery"in element)return YouTube.jQueryVersion=element.jquery,!0}else YouTube.jQueryVersion=null;return!1}.bind(YouTube),YouTube.YouTubeDataContext=function(initializer){if(this.dataCache={},this.successMsgCache={},this.$jqXHRCache={},this.videoId=null,this.$iframe=null,this.iframeSrc="","object"==typeof initializer){var unknownElement=initializer,isJquery=YouTube.isJqueryElement(unknownElement),$element=isJquery?unknownElement:$(unknownElement);if(!$element.attr("src"))return console.error("YoutubeDataContext initializer requires an iframe or video-ID. Actual: ",initializer),this;var $iframe=$element;if("IFRAME"!==$element[0].tagName.toUpperCase()&&($iframe=$element.find("iframe[src]")),!$iframe.length)return console.error("Could not find a usable iframe in initializer."),this;if(this.$iframe=$iframe,this.iframeSrc=$.trim(this.$iframe.attr("src")),this.iframeSrc.indexOf("youtube.com")===-1)return console.error("Not a youtube source."),this;this.videoId=YouTube.getYoutubeVideoIdFromUrl(this.iframeSrc),console.info("YouTubeDataContext initialized from iframe=",this.$iframe,"; VideoID = ",this.videoId)}else"string"==typeof initializer?(this.videoId=initializer,console.info("YouTubeDataContext initialized from VideoID string; VideoID = ",this.videoId)):console.error("YoutubeDataContext initializer requires an iframe or video-ID. Actual: ",initializer);return this},YouTube.getYoutubeVideoIdFromUrl=function(url){var match1=url.match(/youtube.com\/watch\?v=([^\/&\?#]+)(.*)?/);if(null!==match1&&match1.length>=2)return match1[1];var match2=url.match(/youtube.com\/embed\/([^\/&\?#]+)(.*)?/);if(null!==match2&&match2.length>=2)return match2[1];var match3=url.match(/youtube.com\/v\/([^\/&\?#]+)(.*)?/);return null!==match3&&match3.length>=2?match3[1]:""},YouTube.YouTubeDataContext.prototype.fetchYoutubeData=function(callbackOnData,callbackOnError){if(this.videoId in this.dataCache)callbackOnData.apply(this.$jqXHRCache[this.videoId],[this.dataCache[this.videoId],this.successMsgCache[this.videoId],this.$jqXHRCache[this.videoId]]);else{var thisDataContext=this;$.get("//gdata.youtube.com/feeds/api/videos?q="+this.videoId+"&max-results=1&v=2&alt=jsonc",function(data,successMsg,$jqXHR){"success"===successMsg?(console.log("Data returned from YouTube API: ",data),thisDataContext.dataCache[thisDataContext.videoId]=data,thisDataContext.successMsgCache[thisDataContext.videoId]=successMsg,thisDataContext.$jqXHRCache[thisDataContext.videoId]=$jqXHR,callbackOnData.apply($jqXHR,[data,successMsg,$jqXHR])):(console.warn("YouTube data fetch -- error: '"+successMsg+"'"),callbackOnError.apply($jqXHR,[successMsg,$jqXHR,data]))})}},YouTube.YouTubeDataContext.prototype.getLargeThumbnail=function(onImageSrc,onError,defaultImageSrc){var dataContext=this,getThumbnailArgs=$.makeArray(arguments);return getThumbnailArgs.unshift("hqDefault"),dataContext.getThumbnail.apply(dataContext,getThumbnailArgs)},YouTube.YouTubeDataContext.prototype.getSmallThumbnail=function(onImageSrc,onError,defaultImageSrc){var dataContext=this,getThumbnailArgs=$.makeArray(arguments);return getThumbnailArgs.unshift("sqDefault"),dataContext.getThumbnail.apply(dataContext,getThumbnailArgs)},YouTube.YouTubeDataContext.prototype.getThumbnail=function(qualityConst,onImageSrc,onError,defaultImageSrc){var dataContext=this;this.fetchYoutubeData(function(data,successMsg,$jqXHR){var imageSrc;try{var thumbnailData=data.data.items[0].thumbnail;if(!(qualityConst in thumbnailData)){var error__extractThumbnailFromXml="Unrecognized youtube thumbnail quality key: `"+qualityConst+"`";return console.error(error__extractThumbnailFromXml),console.trace(),console.log("Invoking error handler callback.",onError,onError?onError.toString():String(onError)),void onError.apply(dataContext,[defaultImageSrc,error__extractThumbnailFromXml,data])}imageSrc=thumbnailData[qualityConst],onImageSrc.apply(dataContext,[imageSrc,successMsg,$jqXHR])}catch(error__extractThumbnailFromXml){onError.apply(dataContext,[defaultImageSrc,error__extractThumbnailFromXml,data])}},onError)},YouTube});